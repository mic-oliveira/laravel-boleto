<?php


namespace Boleto\Tests\Integration\Services;


use Boleto\Repositories\Eloquent\BilletRepository;
use Boleto\Services\CNAB400Service;
use Mockery;
use Mockery\Mock;
use Mockery\MockInterface;
use Orchestra\Testbench\TestCase;

class CNAB400ServiceTest extends TestCase
{
    private $service;

    protected function setUp(): void
    {
        parent::setUp();
        $this->service = new CNAB400Service(new BilletRepository());
    }

    public function testReadCNAB400()
    {
        echo "ID_BANCO\tCODIGO\tFATURA\tVALOR\n";
        foreach ($this->service->readCNAB400(__DIR__.'/../../../CN15041A.RET') as $lin_num=>$line) {
            if ($lin_num > 0 && $lin_num){
                echo substr($line,127,7)."\t";
                echo substr($line,57,5)."\t";
                echo substr($line,63,7)."\t"; // CODIGO FATURA(NOSSO NUMERO)
                echo bcdiv((int)substr($line,153,12),100,2)."\n"; // VALOR DO BOLETO
            }
        }
    }

    public function testMakeDetails()
    {
        $this->service = $this->mock(CNAB400Service::class, function (MockInterface $mock) {
            $mock->expects('makeDetails')->once()->andReturn(
               "10203432059000147456300399239    00001202104202105100030040530106968230000000000000109                     I01202104000010052100000000079903410000099A150421299400000000000000000000000000000000000000000000000000000000000100060246766700ANA LUCIA CORDOVIL DE LIMA              RUA PAU BRASIL, N 928 CS 14             PRAIA DO HOS28970000ARARUAMA       RJFATURA:202104-10/04/2021 a 10/05/2021 - 00 000001
10203432059000147456300399239    00001202105202106100030040530106968240000000000000109                     I01202105000010062100000000079903410000099A150421299400000000000000000000000000000000000000000000000000000000000100060246766700ANA LUCIA CORDOVIL DE LIMA              RUA PAU BRASIL, N 928 CS 14             PRAIA DO HOS28970000ARARUAMA       RJFATURA:202105-10/05/2021 a 10/06/2021 - 00 000002
10203432059000147456300399239    00001202103202104150020040530106968250000000000000109                     I01202103000015042100000000081633410000099A150421299400000000000000000000000000000000000000000000000000000000000100060246766700ANA LUCIA CORDOVIL DE LIMA              RUA PAU BRASIL, N 928 CS 14             PRAIA DO HOS28970000ARARUAMA       RJFATURA:202103-10/03/2021 a 10/04/2021 - 00 000003
10203432059000147456300399239    00001202104202105200030053024106968260000000000000109                     I01202104000020052100000000099903410000099A150421299400000000000000000000000000000000000000000000000000000000000100019868053790KAREN DOS SANTOS GOMES                  RUA VANESSA, N 92 MURO ROSA             IGUABINHA   28970000ARARUAMA       RJFATURA:202104-14/04/2021 a 14/05/2021 - 00 000004
10203432059000147456300399239    00001202105202106200030053024106968270000000000000109                     I01202105000020062100000000099903410000099A150421299400000000000000000000000000000000000000000000000000000000000100019868053790KAREN DOS SANTOS GOMES                  RUA VANESSA, N 92 MURO ROSA             IGUABINHA   28970000ARARUAMA       RJFATURA:202105-14/05/2021 a 14/06/2021 - 00 000005"
            );
        });
        $this->assertEquals(400, strlen(explode("\n",$this->service->makeDetails([]))[0]));
    }

    public function testMakeFooter()
    {
        echo $this->service->makeFooter(250);
        $this->assertEquals(400, strlen($this->service->makeFooter(250)));
    }
}
